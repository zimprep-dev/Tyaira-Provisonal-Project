{% extends "base.html" %}

{% block title %}Platform Analytics{% endblock %}

{% block content %}
<div id="analytics-data" data-analytics="{{ data|tojson|safe }}" style="display: none;"></div>
<div class="container cms-dashboard">
    <div class="page-header">
        <h1><i data-feather="bar-chart-2"></i> Platform Analytics</h1>
        <p>Insights into test performance, user engagement, and content effectiveness.</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i data-feather="file-text"></i></div>
            <div class="stat-info">
                <div class="stat-number">{{ data.total_tests }}</div>
                <div class="stat-label">Total Tests Taken</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i data-feather="award"></i></div>
            <div class="stat-info">
                <div class="stat-number">{{ data.average_score }}%</div>
                <div class="stat-label">Average Score</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i data-feather="check"></i></div>
            <div class="stat-info">
                <div class="stat-number">{{ data.pass_count }}</div>
                <div class="stat-label">Passed Tests</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i data-feather="x"></i></div>
            <div class="stat-info">
                <div class="stat-number">{{ data.fail_count }}</div>
                <div class="stat-label">Failed Tests</div>
            </div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-card chart-card-full">
            <h3>Performance Trend</h3>
            <canvas id="performanceTrendChart"></canvas>
        </div>
        <div class="charts-row">
            <div class="chart-card">
                <h3>Pass vs. Fail Rate</h3>
                <canvas id="passFailChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Performance by Category (Sample)</h3>
                <canvas id="categoryPerformanceChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analyticsDataEl = document.getElementById('analytics-data');
    const analyticsData = JSON.parse(analyticsDataEl.dataset.analytics);

    // Performance Trend Chart
    if (document.getElementById('performanceTrendChart')) {
        const trendCtx = document.getElementById('performanceTrendChart').getContext('2d');
        const trendLabels = analyticsData.performance_trend ? analyticsData.performance_trend.labels : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        const trendData = analyticsData.performance_trend ? analyticsData.performance_trend.data : [65, 59, 80, 81, 56, 55];

        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Average Score Over Time',
                    data: trendData,
                    borderColor: '#4a5568',
                    backgroundColor: 'rgba(74, 85, 104, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Pass/Fail Chart
    if (document.getElementById('passFailChart')) {
        const passFailCtx = document.getElementById('passFailChart').getContext('2d');
        new Chart(passFailCtx, {
            type: 'pie',
            data: {
                labels: ['Pass', 'Fail'],
                datasets: [{
                    label: 'Test Outcomes',
                    data: [analyticsData.pass_count, analyticsData.fail_count],
                    backgroundColor: ['#28a745', '#dc3545'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }

    // Category Performance Chart
    if (document.getElementById('categoryPerformanceChart')) {
        const categoryCtx = document.getElementById('categoryPerformanceChart').getContext('2d');
        const categoryLabels = Object.keys(analyticsData.performance_by_category || {});
        const categoryData = Object.values(analyticsData.performance_by_category || {});

        new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'Average Score (%)',
                    data: categoryData,
                    backgroundColor: '#667eea',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
