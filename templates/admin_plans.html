{% extends "base.html" %}

{% block title %}Subscription Plans - Admin{% endblock %}

{% block content %}
<div class="cms-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1><i data-feather="package"></i> Subscription Plans</h1>
            <p>Manage subscription plans and pricing</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('admin') }}" class="btn btn-secondary">
                <i data-feather="arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Plans Grid -->
    <div class="plans-grid">
        {% for plan in plans %}
        <div class="plan-card {% if plan.is_featured %}featured{% endif %}">
            <div class="plan-header">
                <div>
                    <h3>{{ plan.name }}</h3>
                    <p class="plan-price">${{ plan.price }} <span>/ {{ plan.duration_months }}mo</span></p>
                </div>
                {% if plan.is_featured %}
                <span class="badge badge-featured"><i data-feather="star"></i></span>
                {% endif %}
            </div>

            <div class="plan-stats">
                <div class="stat-row">
                    <span class="stat-label"><i data-feather="users"></i> {{ plan.active_subscribers if plan.active_subscribers is defined else 0 }} Subscribers</span>
                    {% if plan.is_active %}
                    <span class="badge badge-success">Active</span>
                    {% else %}
                    <span class="badge badge-secondary">Inactive</span>
                    {% endif %}
                </div>
            </div>

            <div class="plan-actions">
                <button class="btn btn-primary btn-sm" onclick="editPlan({{ plan.id }})">
                    <i data-feather="edit-2"></i> Edit
                </button>
                <button class="btn btn-secondary btn-sm" onclick="togglePlan({{ plan.id }}, {{ plan.is_active|lower }})">
                    {% if plan.is_active %}
                    <i data-feather="eye-off"></i> Deactivate
                    {% else %}
                    <i data-feather="eye"></i> Activate
                    {% endif %}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Add New Plan Button -->
    <div class="add-plan-section">
        <button class="btn btn-primary" onclick="showAddPlanModal()">
            <i data-feather="plus"></i> Add New Plan
        </button>
    </div>
</div>

<!-- Plan Creation/Edit Modal -->
<div id="planModal" class="plan-modal">
    <div class="plan-modal-content">
        <div class="plan-modal-header">
            <h2 id="modalTitle">Create New Plan</h2>
            <button class="close-btn" onclick="closePlanModal()">
                <i data-feather="x"></i>
            </button>
        </div>
        
        <form id="planForm" class="plan-form">
            <!-- Basic Information -->
            <div class="form-section">
                <h3>Basic Information</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="planName">Plan Name <span class="required">*</span></label>
                        <input type="text" id="planName" name="name" required placeholder="e.g., Premium Monthly">
                    </div>
                    
                    <div class="form-group">
                        <label for="planType">Plan Type <span class="required">*</span></label>
                        <select id="planType" name="plan_type" required onchange="handlePlanTypeChange()">
                            <option value="subscription">Time-Based Subscription</option>
                            <option value="usage">Usage-Based (Test Credits)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Price (USD) <span class="required">*</span></label>
                        <input type="number" id="price" name="price" step="0.01" min="0" required placeholder="5.00">
                    </div>
                    
                    <div class="form-group" id="durationGroup">
                        <label for="durationMonths">Duration (Months) <span class="required">*</span></label>
                        <input type="number" id="durationMonths" name="duration_months" min="1" value="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3" placeholder="Brief description of this plan..."></textarea>
                </div>
            </div>
            
            <!-- Access Control -->
            <div class="form-section">
                <h3>Access Control & Features</h3>
                
                <div class="form-row" id="testAccessRow">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="unlimitedTests" name="has_unlimited_tests" checked onchange="handleUnlimitedTestsChange()">
                            <span>Unlimited Tests</span>
                        </label>
                        <small>User can take unlimited practice tests</small>
                    </div>
                </div>
                
                <div class="form-row" id="creditsRow" style="display: none;">
                    <div class="form-group">
                        <label for="testCredits">Test Credits</label>
                        <input type="number" id="testCredits" name="test_credits" min="0" value="0" placeholder="e.g., 10">
                        <small>Number of tests included (for usage-based plans)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="maxTests">Max Tests Per Month</label>
                        <input type="number" id="maxTests" name="max_tests_per_month" min="1" placeholder="e.g., 50">
                        <small>Monthly test limit (leave empty for unlimited)</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="downloadAccess" name="has_download_access" checked>
                            <span>PDF Download Access</span>
                        </label>
                        <small>User can download study materials and PDFs</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="progressTracking" name="has_progress_tracking" checked>
                            <span>Progress Tracking</span>
                        </label>
                        <small>Track user progress and history</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="analytics" name="has_performance_analytics" checked>
                            <span>Performance Analytics</span>
                        </label>
                        <small>Detailed performance analytics and insights</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="featured" name="is_featured">
                            <span>Featured Plan</span>
                        </label>
                        <small>Highlight this plan with a badge</small>
                    </div>
                </div>
            </div>
            
            <!-- Plan Summary -->
            <div class="form-section plan-summary">
                <h3>Plan Summary</h3>
                <div id="planSummary" class="summary-content">
                    <!-- Dynamically populated -->
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closePlanModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Plan</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    feather.replace();
    updatePlanSummary();
    
    // Add event listeners for live summary update
    document.getElementById('planForm').addEventListener('input', updatePlanSummary);
    document.getElementById('planForm').addEventListener('change', updatePlanSummary);
});

function showAddPlanModal() {
    const form = document.getElementById('planForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    document.getElementById('planModal').style.display = 'flex';
    document.getElementById('modalTitle').textContent = 'Create New Plan';
    form.reset();
    delete form.dataset.editId; // Clear edit mode
    submitBtn.textContent = 'Create Plan';
    
    // Use setTimeout to ensure DOM is ready
    setTimeout(() => {
        handlePlanTypeChange();
        feather.replace();
    }, 10);
}

function closePlanModal() {
    document.getElementById('planModal').style.display = 'none';
}

function handlePlanTypeChange() {
    const planType = document.getElementById('planType').value;
    const durationGroup = document.getElementById('durationGroup');
    const durationInput = document.getElementById('durationMonths');
    const testAccessRow = document.getElementById('testAccessRow');
    const creditsRow = document.getElementById('creditsRow');
    
    if (planType === 'usage') {
        // Usage-based plan - disable and hide duration
        durationGroup.style.display = 'none';
        durationInput.value = 0;
        durationInput.disabled = true; // Disable instead of removing required
        document.getElementById('unlimitedTests').checked = false;
        document.getElementById('unlimitedTests').disabled = true;
        creditsRow.style.display = 'flex';
        testAccessRow.style.display = 'none';
    } else {
        // Subscription plan - enable and show duration
        durationGroup.style.display = 'block';
        durationInput.value = 1;
        durationInput.disabled = false; // Enable for subscription plans
        document.getElementById('unlimitedTests').disabled = false;
        testAccessRow.style.display = 'flex';
        handleUnlimitedTestsChange();
    }
    
    updatePlanSummary();
}

function handleUnlimitedTestsChange() {
    const unlimited = document.getElementById('unlimitedTests').checked;
    const creditsRow = document.getElementById('creditsRow');
    
    if (unlimited) {
        creditsRow.style.display = 'none';
        document.getElementById('testCredits').value = 0;
        document.getElementById('maxTests').value = '';
    } else {
        creditsRow.style.display = 'flex';
    }
    
    updatePlanSummary();
}

function updatePlanSummary() {
    const planType = document.getElementById('planType').value;
    const name = document.getElementById('planName').value || '[Plan Name]';
    const price = document.getElementById('price').value || '0.00';
    const duration = document.getElementById('durationMonths').value;
    const unlimited = document.getElementById('unlimitedTests').checked;
    const credits = document.getElementById('testCredits').value;
    const maxTests = document.getElementById('maxTests').value;
    const hasDownloads = document.getElementById('downloadAccess').checked;
    const hasTracking = document.getElementById('progressTracking').checked;
    const hasAnalytics = document.getElementById('analytics').checked;
    
    let summaryHTML = `
        <div class="summary-item">
            <strong>${name}</strong>
            <span class="summary-price">$${price}</span>
        </div>
    `;
    
    if (planType === 'subscription') {
        summaryHTML += `<div class="summary-item"><span>Duration:</span><span>${duration} ${duration == 1 ? 'month' : 'months'}</span></div>`;
    } else {
        summaryHTML += `<div class="summary-item"><span>Type:</span><span>One-time purchase</span></div>`;
    }
    
    // Test access
    if (unlimited && planType === 'subscription') {
        summaryHTML += `<div class="summary-item"><i data-feather="check" class="summary-icon-check"></i><span>Unlimited tests</span></div>`;
    } else if (credits && planType === 'usage') {
        summaryHTML += `<div class="summary-item"><i data-feather="check" class="summary-icon-check"></i><span>${credits} test credits</span></div>`;
    } else if (maxTests) {
        summaryHTML += `<div class="summary-item"><i data-feather="check" class="summary-icon-check"></i><span>Up to ${maxTests} tests/month</span></div>`;
    }
    
    // Features
    if (hasDownloads) {
        summaryHTML += `<div class="summary-item"><i data-feather="check" class="summary-icon-check"></i><span>PDF Downloads</span></div>`;
    }
    if (hasTracking) {
        summaryHTML += `<div class="summary-item"><i data-feather="check" class="summary-icon-check"></i><span>Progress Tracking</span></div>`;
    }
    if (hasAnalytics) {
        summaryHTML += `<div class="summary-item"><i data-feather="check" class="summary-icon-check"></i><span>Performance Analytics</span></div>`;
    }
    
    document.getElementById('planSummary').innerHTML = summaryHTML;
    feather.replace();
}

async function editPlan(planId) {
    try {
        // Fetch plan data
        const response = await fetch(`/admin/plans/get/${planId}`);
        const plan = await response.json();
        
        if (!response.ok) {
            Modal.alert(plan.error || 'Failed to load plan data', 'error');
            return;
        }
        
        // Open modal in edit mode
        document.getElementById('planModal').style.display = 'flex';
        document.getElementById('modalTitle').textContent = 'Edit Plan';
        
        // Populate form
        document.getElementById('planName').value = plan.name;
        document.getElementById('planType').value = plan.plan_type;
        document.getElementById('price').value = plan.price;
        document.getElementById('durationMonths').value = plan.duration_months;
        document.getElementById('description').value = plan.description;
        
        // Checkboxes
        document.getElementById('unlimitedTests').checked = plan.has_unlimited_tests;
        document.getElementById('testCredits').value = plan.test_credits;
        document.getElementById('maxTests').value = plan.max_tests_per_month || '';
        document.getElementById('downloadAccess').checked = plan.has_download_access;
        document.getElementById('progressTracking').checked = plan.has_progress_tracking;
        document.getElementById('analytics').checked = plan.has_performance_analytics;
        document.getElementById('featured').checked = plan.is_featured;
        
        // Set form action to edit
        const form = document.getElementById('planForm');
        form.dataset.editId = planId;
        
        // Update button text
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Update Plan';
        
        // Handle plan type specific fields
        handlePlanTypeChange();
        
        feather.replace();
    } catch (error) {
        Modal.alert('Error loading plan: ' + error.message, 'error');
    }
}

function togglePlan(planId, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    Modal.confirm(
        `Are you sure you want to ${action} this plan?`,
        `${action.charAt(0).toUpperCase() + action.slice(1)} Plan`
    ).then(confirmed => {
        if (confirmed) {
            // TODO: Implement actual toggle
            Modal.alert(`Plan ${action}d successfully!`, 'success');
        }
    });
}

// Form submission
document.getElementById('planForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const editId = form.dataset.editId;
    const isEditing = !!editId;
    
    const formData = new FormData(form);
    const planData = {};
    
    // Convert FormData to object
    formData.forEach((value, key) => {
        if (key.startsWith('has_') || key === 'is_featured') {
            planData[key] = formData.get(key) !== null;
        } else if (key === 'price' || key.includes('duration') || key.includes('credits') || key.includes('max_')) {
            planData[key] = parseFloat(value) || 0;
        } else {
            planData[key] = value;
        }
    });
    
    // Calculate duration_days from duration_months
    if (planData.plan_type === 'subscription') {
        planData.duration_days = planData.duration_months * 30;
    } else {
        planData.duration_days = 0;
        planData.duration_months = 0;
    }
    
    try {
        const url = isEditing ? `/admin/plans/edit/${editId}` : '/admin/plans/add';
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(planData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            Modal.alert(isEditing ? 'Plan updated successfully!' : 'Plan created successfully!', 'success');
            closePlanModal();
            location.reload();
        } else {
            Modal.alert(result.error || `Failed to ${isEditing ? 'update' : 'create'} plan`, 'error');
        }
    } catch (error) {
        Modal.alert(`Error ${isEditing ? 'updating' : 'creating'} plan: ` + error.message, 'error');
    }
});
</script>

<style>
.plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.plan-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.plan-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.plan-card.featured {
    border-color: #fbbf24;
}

.plan-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
}

.plan-header h3 {
    margin: 0 0 0.25rem 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #2d3748;
}

.plan-price {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #2d3748;
}

.plan-price span {
    font-size: 0.875rem;
    font-weight: 400;
    color: #718096;
}

.plan-stats {
    padding: 0.75rem 0;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stat-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #4a5568;
}

.stat-label i {
    width: 16px;
    height: 16px;
}

.plan-actions {
    display: flex;
    gap: 0.5rem;
}

.plan-actions button {
    flex: 1;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

.add-plan-section {
    text-align: center;
    padding: 2rem;
}

.badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-featured {
    background: #fef3c7;
    color: #92400e;
}

.badge-success {
    background: #c6f6d5;
    color: #22543d;
}

.badge-secondary {
    background: #e2e8f0;
    color: #4a5568;
}

.badge i {
    width: 12px;
    height: 12px;
}

/* Plan Modal Styles */
.plan-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    overflow-y: auto;
}

.plan-modal-content {
    background: white;
    border-radius: 12px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.plan-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e2e8f0;
}

.plan-modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #2d3748;
}

.close-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    color: #718096;
    border-radius: 4px;
    display: flex;
    align-items: center;
}

.close-btn:hover {
    background: #f7fafc;
    color: #2d3748;
}

.close-btn i {
    width: 20px;
    height: 20px;
}

.plan-form {
    padding: 2rem;
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e2e8f0;
}

.form-section:last-of-type {
    border-bottom: none;
}

.form-section h3 {
    margin: 0 0 1.5rem 0;
    font-size: 1.125rem;
    color: #2d3748;
    font-weight: 600;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-row:last-child {
    margin-bottom: 0;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #4a5568;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 0.625rem 0.75rem;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.form-group small {
    font-size: 0.75rem;
    color: #718096;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-weight: 600;
    color: #2d3748;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.required {
    color: #e53e3e;
}

.plan-summary {
    background: #f7fafc;
    border-radius: 8px;
    padding: 1.5rem !important;
}

.summary-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
}

.summary-item:first-child {
    padding-bottom: 0.75rem;
    margin-bottom: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
}

.summary-price {
    font-size: 1.5rem;
    font-weight: 700;
    color: #48bb78;
}

.summary-icon-check {
    width: 16px;
    height: 16px;
    color: #48bb78;
    margin-right: 0.5rem;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 1.5rem;
    margin-top: 1.5rem;
    border-top: 1px solid #e2e8f0;
}

@media (max-width: 768px) {
    .plans-grid {
        grid-template-columns: 1fr;
    }
    
    .plan-modal {
        padding: 1rem;
    }
    
    .plan-modal-content {
        max-height: 95vh;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .modal-actions {
        flex-direction: column-reverse;
    }
    
    .modal-actions button {
        width: 100%;
    }
}
</style>
{% endblock %}
