{% extends "base.html" %}

{% block title %}Take Test - Driver Testing Platform{% endblock %}

{% block body_class %}test-page-active test-mode{% endblock %}

{% block content %}
<div class="test-interface" data-category="{{ category }}">
    <div class="test-main-content">
        <!-- Optimized Test Header -->
        <div class="test-header">
            <div class="test-category-info">
                <i data-feather="book-open"></i>
                <span id="headerCategory">Driving Theory Test</span>
            </div>
            <div class="test-question-indicator">
                <span>Question <span id="currentQuestion">1</span> of <span id="totalQuestions">25</span></span>
            </div>
            <div class="test-timer">
                <i data-feather="clock"></i>
                <span id="timeRemaining">08:00</span>
            </div>
        </div>

        <!-- Question Container -->
        <div class="question-card">
            <div class="question-content-wrapper">
                <!-- Question Content -->
                <div class="question-body">
                    <!-- Question Image -->
                    <div class="question-image">
                        <div class="image-container" id="imageContainer">
                            <div class="image-placeholder" id="imagePlaceholder">
                                <div class="placeholder-icon"><i data-feather="image"></i></div>
                                <p>Traffic diagram will appear here</p>
                            </div>
                            <img id="questionImage" style="display: none;">
                        </div>
                        <div class="image-controls" id="imageControls" style="display: none;">
                            <button class="btn-image-zoom" onclick="zoomTestImage(0.1)" title="Zoom In">
                                <i data-feather="plus"></i>
                            </button>
                            <button class="btn-image-zoom" onclick="zoomTestImage(-0.1)" title="Zoom Out">
                                <i data-feather="minus"></i>
                            </button>
                            <button class="btn-image-zoom" onclick="resetTestImageZoom()" title="Reset">
                                <i data-feather="maximize-2"></i>
                            </button>
                        </div>
                    </div>

                    <div class="question-text-and-options">
                        <!-- Question Text -->
                        <div class="question-text">
                            <h3 id="questionText">Loading question...</h3>
                        </div>

                        <!-- Answer Options -->
                        <div class="answer-options" id="answerOptions">
                            <div class="option-item" data-option="A">
                                <input type="radio" name="answer" value="A" id="optionA">
                                <label for="optionA">
                                    <div class="option-marker">A</div>
                                    <div class="option-text" id="optionAText">Option A</div>
                                </label>
                            </div>
                            <div class="option-item" data-option="B">
                                <input type="radio" name="answer" value="B" id="optionB">
                                <label for="optionB">
                                    <div class="option-marker">B</div>
                                    <div class="option-text" id="optionBText">Option B</div>
                                </label>
                            </div>
                            <div class="option-item" data-option="C">
                                <input type="radio" name="answer" value="C" id="optionC">
                                <label for="optionC">
                                    <div class="option-marker">C</div>
                                    <div class="option-text" id="optionCText">Option C</div>
                                </label>
                            </div>
                            <div class="option-item" data-option="D">
                                <input type="radio" name="answer" value="D" id="optionD">
                                <label for="optionD">
                                    <div class="option-marker">D</div>
                                    <div class="option-text" id="optionDText">Option D</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Footer / Navigation -->
            <div class="question-footer">
                <div class="nav-left">
                    <button class="btn btn-secondary" id="prevBtn" disabled>
                        <i data-feather="arrow-left"></i> Previous
                    </button>
                </div>
                <div class="nav-center">
                    <button class="btn btn-outline-secondary" id="flagBtn">
                        <i data-feather="flag"></i> Flag for Review
                    </button>
                </div>
                <div class="nav-right">
                    <button class="btn btn-primary" id="nextBtn">
                        Next <i data-feather="arrow-right"></i>
                    </button>
                    <button class="btn btn-success" id="finishBtn" style="display: none;">
                        <i data-feather="check-circle"></i> Finish Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Navigator -->
    <div class="question-navigator">
        <h3>Question Navigator</h3>
        <div class="question-grid" id="questionGrid">
            <!-- Question numbers will be generated by JavaScript -->
        </div>
        <div class="navigator-legend">
            <div class="legend-item">
                <div class="legend-color answered"></div>
                <span>Answered</span>
            </div>
            <div class="legend-item">
                <div class="legend-color flagged"></div>
                <span>Flagged</span>
            </div>
            <div class="legend-item">
                <div class="legend-color current"></div>
                <span>Current</span>
            </div>
            <div class="legend-item">
                <div class="legend-color unanswered"></div>
                <span>Unanswered</span>
            </div>
        </div>
    </div>
</div>

<!-- Image Zoom Modal -->
<div id="imageZoomModal" class="modal" style="display: none;">
    <div class="modal-content image-zoom">
        <div class="modal-header">
            <h2><i data-feather="search"></i> Question Image</h2>
            <button class="modal-close" id="closeImageZoomBtn">&times;</button>
        </div>
        <div class="zoom-container">
            <div class="zoomed-image" id="zoomedImage">
                <div class="zoom-placeholder">
                    <div class="placeholder-icon"><i data-feather="image"></i></div>
                    <p>Zoomed image will appear here</p>
                </div>
            </div>
            <div class="zoom-controls">
                <button class="btn btn-secondary" id="zoomInBtn"><i data-feather="zoom-in"></i> Zoom In</button>
                <button class="btn btn-secondary" id="zoomOutBtn"><i data-feather="zoom-out"></i> Zoom Out</button>
                <button class="btn btn-secondary" id="resetImageZoomBtn"><i data-feather="rotate-ccw"></i> Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div id="resultsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i data-feather="award"></i> Test Results</h2>
        </div>
        <div class="results-content">
            <div class="score-circle" id="scoreCircle">
                <svg class="progress-ring" width="120" height="120">
                    <circle class="progress-ring__circle" stroke="#e6e6e6" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                    <circle class="progress-ring__circle--progress" stroke="#28a745" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                </svg>
                <span class="score-percentage" id="scorePercentage">0%</span>
            </div>
            <div class="score-summary">
                <p>You scored <strong id="scoreValue">0/0</strong>.</p>
                <p id="resultMessage">Keep practicing!</p>
            </div>
            <div class="results-actions">
                <button class="btn btn-primary" onclick="window.location.href='/dashboard'">
                    <i data-feather="home"></i> Back to Dashboard
                </button>
                <a href="#" id="reviewAnswersBtn" class="btn btn-secondary" style="display: none;">
                    <i data-feather="check-square"></i> Review Answers
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Test Completion Modal -->
<div id="completionModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i data-feather="clock"></i> Test Completion</h2>
        </div>
        <div class="completion-content">
            <div class="completion-stats">
                <div class="stat-item">
                    <span class="stat-label">Questions Answered:</span>
                    <span class="stat-value" id="answeredCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Questions Flagged:</span>
                    <span class="stat-value" id="flaggedCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Time Used:</span>
                    <span class="stat-value" id="timeUsed">0:00</span>
                </div>
            </div>
            <div class="completion-warning">
                <p><i data-feather="alert-triangle"></i> Are you sure you want to submit your test?</p>
                <p>You cannot change your answers after submission.</p>
            </div>
            <div class="completion-actions">
                <button class="btn btn-secondary" id="continueTestBtn">
                    Continue Test
                </button>
                <button class="btn btn-primary" id="submitTestBtn">
                    <i data-feather="check-circle"></i> Submit Test
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/test-interface.js') }}"></script>
<script>
    // window.zoomIn = testInterface.zoomIn.bind(testInterface);
    // window.zoomOut = testInterface.zoomOut.bind(testInterface);
    // window.resetZoom = testInterface.resetZoom.bind(testInterface);

    document.addEventListener('DOMContentLoaded', () => {
        // Switch to test navigation mode
        switchToTestMode();
        testInterface.initializeTest();
    });

    function switchToTestMode() {
        document.getElementById('mainNavbar').style.display = 'none';
        document.getElementById('testNavbar').style.display = 'block';
        document.body.classList.add('test-mode');
    }

    function exitTest() {
        if (confirm('Are you sure you want to exit the test? Your progress will be lost.')) {
            window.location.href = '{{ url_for("take_test") }}';
        }
    }

    function toggleMainNav() {
        const mainNav = document.getElementById('mainNavbar');
        const isVisible = mainNav.style.display !== 'none';
        mainNav.style.display = isVisible ? 'none' : 'block';
        
        // Update button icon
        const btn = document.getElementById('navCollapseBtn');
        const icon = btn.querySelector('i');
        if (icon) icon.setAttribute('data-feather', isVisible ? 'menu' : 'x');
        if (window.feather) feather.replace();
    }

    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (e.key >= '1' && e.key <= '4') testInterface.selectOption(['A', 'B', 'C', 'D'][parseInt(e.key) - 1]);
        else if (e.key === 'ArrowLeft') { e.preventDefault(); testInterface.previousQuestion(); }
        else if (e.key === 'ArrowRight') { e.preventDefault(); testInterface.nextQuestion(); }
        else if (e.key.toLowerCase() === 'f') { e.preventDefault(); testInterface.flagQuestion(); }
    });
</script>
{% endblock %}
