{% extends "base.html" %}

{% block title %}Profile - Driver Testing Platform{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1><i data-feather="user"></i> User Profile</h1>
        <p>Manage your account and view your progress</p>
    </div>

    <div class="profile-content">
        <!-- Profile Information -->
        <div class="profile-section">
            <h2>Account Information</h2>
            <div class="profile-info">
                <div class="info-group">
                    <label>Username</label>
                    <span>{{ user.username }}</span>
                </div>
                <div class="info-group">
                    <label>Email</label>
                    <span>{{ user.email }}</span>
                </div>
                <div class="info-group">
                    <label>Account Type</label>
                    <span class="account-type">
                        {% if user.is_subscriber %}
                            <span class="badge premium">Premium Subscriber</span>
                            {% if user.subscription_date %}
                                <small>Since {{ user.subscription_date.strftime('%Y-%m-%d') }}</small>
                            {% endif %}
                        {% else %}
                            <span class="badge free">Free Tier</span>
                        {% endif %}
                    </span>
                </div>
                
                {% if user.is_subscriber %}
                <div class="info-group subscription-actions">
                    <label>Subscription Management</label>
                    <button class="btn btn-danger btn-sm" onclick="showCancelModal()">
                        <i data-feather="x-circle"></i> Cancel Subscription
                    </button>
                </div>
                {% endif %}
                <div class="info-group">
                    <label>Member Since</label>
                    <span>
                        {% if user.tests_taken and user.tests_taken[0].test_date %}
                            {{ user.tests_taken[0].test_date.strftime('%Y-%m-%d') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
            </div>
            
            {% if not user.has_active_subscription() %}
            <div class="upgrade-section">
                <h3>Upgrade to Premium</h3>
                <p>Get unlimited access to tests and downloads for just $3/month</p>
                <a href="{{ url_for('subscribe') }}" class="btn btn-primary">Upgrade Now</a>
            </div>
            {% endif %}
        </div>

        <!-- Statistics Overview -->
        <div class="profile-section">
            <h2>Your Statistics</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-icon"><i data-feather="bar-chart-2"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">{{ user.tests_taken|length }}</div>
                        <div class="stat-label">Tests Taken</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i data-feather="book"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">{{ user.downloads_count }}</div>
                        <div class="stat-label">Downloads</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i data-feather="target"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">
                            {% if user.tests_taken %}
                                {{ "%.1f"|format(user.tests_taken|map(attribute='score')|sum / user.tests_taken|length) }}/5
                            {% else %}
                                0/5
                            {% endif %}
                        </div>
                        <div class="stat-label">Average Score</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i data-feather="clock"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">
                            {% if user.tests_taken %}
                                {{ "%.1f"|format(user.tests_taken|map(attribute='time_taken')|sum / user.tests_taken|length) }}s
                            {% else %}
                                0s
                            {% endif %}
                        </div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test History -->
        <div class="profile-section">
            <h2>Test History</h2>
            {% if user.tests_taken %}
            <div class="test-history">
                <div class="history-filters">
                    <button class="filter-btn active" onclick="filterTests('all')">All Tests</button>
                    <button class="filter-btn" onclick="filterTests('recent')">Recent</button>
                    <button class="filter-btn" onclick="filterTests('best')">Best Scores</button>
                </div>
                
                <div class="history-list">
                    {% for test in user.tests_taken %}
                    <div class="history-item" data-score="{{ test.score }}" data-date="{{ test.test_date.isoformat() if test.test_date else '' }}">
                        <div class="test-info">
                            <div class="test-date">{{ test.test_date.strftime('%Y-%m-%d %H:%M') if test.test_date else 'N/A' }}</div>
                            <div class="test-score">
                                <span class="score">{{ test.score }}/{{ test.total_questions }}</span>
                                <span class="percentage">({{ "%.1f"|format(test.score / test.total_questions * 100) }}%)</span>
                            </div>
                            <div class="test-time">{{ test.time_taken }}s</div>
                        </div>
                        <div class="test-performance">
                            {% set percentage = (test.score / test.total_questions * 100) %}
                            {% if percentage >= 80 %}
                                <span class="performance excellent">Excellent</span>
                            {% elif percentage >= 60 %}
                                <span class="performance good">Good</span>
                            {% elif percentage >= 40 %}
                                <span class="performance fair">Fair</span>
                            {% else %}
                                <span class="performance poor">Needs Improvement</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="no-tests">
                <p>You haven't taken any tests yet.</p>
                <a href="{{ url_for('take_test') }}" class="btn btn-primary">Take Your First Test</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function filterTests(filter) {
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => btn.classList.remove('active'));
    const ev = window.event || undefined;
    if (ev && ev.target) {
        ev.target.classList.add('active');
    }
    
    const historyItems = document.querySelectorAll('.history-item');
    const items = Array.from(historyItems);
    
    switch(filter) {
        case 'recent':
            items.sort((a, b) => new Date(b.dataset.date) - new Date(a.dataset.date));
            break;
        case 'best':
            items.sort((a, b) => parseInt(b.dataset.score) - parseInt(a.dataset.score));
            break;
        default:
            items.sort((a, b) => new Date(b.dataset.date) - new Date(a.dataset.date));
    }
    
    const historyList = document.querySelector('.history-list');
    historyList.innerHTML = '';
    items.forEach(item => historyList.appendChild(item));
}

function showCancelModal() {
    document.getElementById('cancelSubscriptionModal').style.display = 'flex';
    if (window.feather) feather.replace();
}

function hideCancelModal() {
    document.getElementById('cancelSubscriptionModal').style.display = 'none';
}

function confirmCancelSubscription() {
    const form = document.getElementById('cancelSubscriptionForm');
    form.submit();
}
</script>

<!-- Cancel Subscription Modal -->
<div id="cancelSubscriptionModal" class="modal" style="display: none;">
    <div class="modal-content small">
        <div class="modal-header danger">
            <h2><i data-feather="alert-triangle"></i> Cancel Subscription</h2>
            <button class="modal-close" onclick="hideCancelModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p class="cancel-warning">Are you sure you want to cancel your premium subscription?</p>
            <div class="cancel-info-box">
                <h4>What happens when you cancel:</h4>
                <ul>
                    <li><i data-feather="check"></i> You'll retain premium access until the end of your current billing period</li>
                    <li><i data-feather="x"></i> No refunds will be issued for the current month</li>
                    <li><i data-feather="x"></i> After cancellation, you'll return to the Free Tier</li>
                    <li><i data-feather="info"></i> You can resubscribe at any time</li>
                </ul>
            </div>
            <p class="cancel-note"><strong>Note:</strong> This action cannot be undone. Your subscription will not auto-renew.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideCancelModal()">Keep Subscription</button>
            <form id="cancelSubscriptionForm" method="POST" action="{{ url_for('cancel_subscription') }}" style="display: inline;">
                <button type="submit" class="btn btn-danger">
                    <i data-feather="x-circle"></i> Cancel Subscription
                </button>
            </form>
        </div>
    </div>
</div>

<style>
.subscription-actions {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
}

.cancel-warning {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1a202c;
    margin-bottom: 1.5rem;
}

.cancel-info-box {
    background: #fff5f5;
    border-left: 4px solid #dc3545;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.cancel-info-box h4 {
    color: #2d3748;
    font-size: 1rem;
    margin-bottom: 1rem;
}

.cancel-info-box ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.cancel-info-box li {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    color: #4a5568;
    margin-bottom: 0.75rem;
    line-height: 1.6;
}

.cancel-info-box li:last-child {
    margin-bottom: 0;
}

.cancel-info-box li i {
    flex-shrink: 0;
    margin-top: 0.125rem;
}

.cancel-note {
    color: #718096;
    font-size: 0.9375rem;
    margin: 0;
}

.cancel-note strong {
    color: #2d3748;
}
</style>
{% endblock %}
