{% extends "base.html" %}

{% block title %}Profile - Driver Testing Platform{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1><i data-feather="user"></i> User Profile</h1>
        <p>Manage your account and view your progress</p>
    </div>

    <div class="profile-content">
        <!-- Profile Information -->
        <div class="profile-section">
            <h2>Account Information</h2>
            <div class="profile-info">
                <div class="info-group">
                    <label>Username</label>
                    <span>{{ user.username }}</span>
                </div>
                <div class="info-group">
                    <label>Email</label>
                    <span>{{ user.email }}</span>
                </div>
                <div class="info-group">
                    <label>Account Type</label>
                    <span class="account-type">
                        {% if user.is_subscriber %}
                            <span class="badge premium">Premium Subscriber</span>
                            {% if user.subscription_date %}
                                <small>Since {{ user.subscription_date.strftime('%Y-%m-%d') }}</small>
                            {% endif %}
                        {% else %}
                            <span class="badge free">Free Tier</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-group">
                    <label>Member Since</label>
                    <span>
                        {% if user.tests_taken and user.tests_taken[0].test_date %}
                            {{ user.tests_taken[0].test_date.strftime('%Y-%m-%d') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
            </div>
            
            {% if not user.is_subscriber %}
            <div class="upgrade-section">
                <h3>Upgrade to Premium</h3>
                <p>Get unlimited access to tests and downloads for just $3/month</p>
                <a href="{{ url_for('subscribe') }}" class="btn btn-primary">Upgrade Now</a>
            </div>
            {% endif %}
        </div>

        <!-- Statistics Overview -->
        <div class="profile-section">
            <h2>Your Statistics</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-icon"><i data-feather="bar-chart-2"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">{{ user.tests_taken|length }}</div>
                        <div class="stat-label">Tests Taken</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i data-feather="book"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">{{ user.downloads_count }}/3</div>
                        <div class="stat-label">Downloads Used</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i data-feather="target"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">
                            {% if user.tests_taken %}
                                {{ "%.1f"|format(user.tests_taken|map(attribute='score')|sum / user.tests_taken|length) }}/5
                            {% else %}
                                0/5
                            {% endif %}
                        </div>
                        <div class="stat-label">Average Score</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i data-feather="clock"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">
                            {% if user.tests_taken %}
                                {{ "%.1f"|format(user.tests_taken|map(attribute='time_taken')|sum / user.tests_taken|length) }}s
                            {% else %}
                                0s
                            {% endif %}
                        </div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test History -->
        <div class="profile-section">
            <h2>Test History</h2>
            {% if user.tests_taken %}
            <div class="test-history">
                <div class="history-filters">
                    <button class="filter-btn active" onclick="filterTests('all')">All Tests</button>
                    <button class="filter-btn" onclick="filterTests('recent')">Recent</button>
                    <button class="filter-btn" onclick="filterTests('best')">Best Scores</button>
                </div>
                
                <div class="history-list">
                    {% for test in user.tests_taken %}
                    <div class="history-item" data-score="{{ test.score }}" data-date="{{ test.test_date.isoformat() if test.test_date else '' }}">
                        <div class="test-info">
                            <div class="test-date">{{ test.test_date.strftime('%Y-%m-%d %H:%M') if test.test_date else 'N/A' }}</div>
                            <div class="test-score">
                                <span class="score">{{ test.score }}/{{ test.total_questions }}</span>
                                <span class="percentage">({{ "%.1f"|format(test.score / test.total_questions * 100) }}%)</span>
                            </div>
                            <div class="test-time">{{ test.time_taken }}s</div>
                        </div>
                        <div class="test-performance">
                            {% set percentage = (test.score / test.total_questions * 100) %}
                            {% if percentage >= 80 %}
                                <span class="performance excellent">Excellent</span>
                            {% elif percentage >= 60 %}
                                <span class="performance good">Good</span>
                            {% elif percentage >= 40 %}
                                <span class="performance fair">Fair</span>
                            {% else %}
                                <span class="performance poor">Needs Improvement</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="no-tests">
                <p>You haven't taken any tests yet.</p>
                <a href="{{ url_for('take_test') }}" class="btn btn-primary">Take Your First Test</a>
            </div>
            {% endif %}
        </div>

        <!-- Performance Chart -->
        {% if user.tests_taken|length > 1 %}
        <div class="profile-section">
            <h2>Performance Trend</h2>
            <div class="chart-container">
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if user.tests_taken|length > 1 %}
    {% set ns = namespace(dates=[]) %}
    {% for t in user.tests_taken %}
        {% set _ = ns.dates.append(t.test_date.strftime('%m-%d') if t.test_date else '') %}
    {% endfor %}
    <script id="chart-data" type="application/json">{"scores": {{ user.tests_taken|map(attribute='score')|list|tojson }}, "dates": {{ ns.dates|tojson }}}</script>
{% endif %}

<script>
function filterTests(filter) {
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => btn.classList.remove('active'));
    const ev = window.event || undefined;
    if (ev && ev.target) {
        ev.target.classList.add('active');
    }
    
    const historyItems = document.querySelectorAll('.history-item');
    const items = Array.from(historyItems);
    
    switch(filter) {
        case 'recent':
            items.sort((a, b) => new Date(b.dataset.date) - new Date(a.dataset.date));
            break;
        case 'best':
            items.sort((a, b) => parseInt(b.dataset.score) - parseInt(a.dataset.score));
            break;
        default:
            items.sort((a, b) => new Date(b.dataset.date) - new Date(a.dataset.date));
    }
    
    const historyList = document.querySelector('.history-list');
    historyList.innerHTML = '';
    items.forEach(item => historyList.appendChild(item));
}

// Performance Chart (if Chart.js is available)
if (typeof Chart !== 'undefined' && document.getElementById('performanceChart')) {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    let testData = [];
    let testDates = [];
    const dataEl = document.getElementById('chart-data');
    if (dataEl) {
        try {
            const parsed = JSON.parse(dataEl.textContent);
            testData = parsed.scores || [];
            testDates = parsed.dates || [];
        } catch (e) {
            console.error('Failed to parse chart data', e);
        }
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: testDates,
            datasets: [{
                label: 'Test Scores',
                data: testData,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5
                }
            }
        }
    });
}
</script>
{% endblock %}
