{% extends "base.html" %}

{% block title %}Dashboard - Driver Testing Platform{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1><i data-feather="user" class="dashboard-icon"></i> Welcome, {{ user.username }}!</h1>
        <div class="user-status">
            {% if user.has_active_subscription() %}
                {% if user.is_subscriber %}
                    <span class="status-badge subscribed"><i data-feather="star" class="badge-icon"></i> Premium Subscriber</span>
                {% else %}
                    <span class="status-badge subscribed"><i data-feather="star" class="badge-icon"></i> Premium (Cancelled)</span>
                {% endif %}
            {% else %}
                <span class="status-badge free"><i data-feather="user" class="badge-icon"></i> Free Tier</span>
            {% endif %}
        </div>
    </div>

    <div class="dashboard-stats">
        <div class="stat-card">
            <h3><i data-feather="check-circle" class="stat-icon"></i> Tests Taken</h3>
            <div class="stat-number">{{ user.tests_taken|length }}</div>
        </div>
        <div class="stat-card">
            <h3><i data-feather="download" class="stat-icon"></i> Downloads</h3>
            <div class="stat-number">{{ user.downloads_count }}</div>
        </div>
        {% if user.has_active_subscription() %}
            <div class="stat-card">
                <h3><i data-feather="star" class="stat-icon"></i> Subscription</h3>
                <div class="stat-number">{% if user.is_subscriber %}Active{% else %}Ending Soon{% endif %}</div>
            </div>
        {% endif %}
    </div>

    <div class="dashboard-actions">
        <div class="action-card">
            <h3><i data-feather="play-circle" class="action-icon"></i> Take a Test</h3>
            <p>Practice with our interactive driving test questions</p>
            <a href="{{ url_for('take_test') }}" class="btn btn-primary">Start Test</a>
        </div>
        
        <div class="action-card">
            <h3><i data-feather="download-cloud" class="action-icon"></i> Download Resources</h3>
            <p>Get study materials and practice questions</p>
            <button id="downloadResourcesBtn" class="btn btn-secondary">Download PDF</button>
        </div>
        
        {% if not user.has_active_subscription() %}
        <div class="action-card featured">
            <h3><i data-feather="zap" class="action-icon"></i> Upgrade to Premium</h3>
            <p>Get unlimited access for just $3/month</p>
            <a href="{{ url_for('subscribe') }}" class="btn btn-primary">Subscribe Now</a>
        </div>
        {% endif %}
    </div>

    {% if tests %}
    <div class="recent-tests">
        <h2><i data-feather="activity" class="section-icon"></i> Recent Test Results</h2>
        <div class="test-results">
            {% for test in tests %}
            <div class="test-result">
                <div class="test-date">{{ test.test_date.strftime('%Y-%m-%d %H:%M') }}</div>
                <div class="test-score">
                    <span class="score">{{ test.score }}/{{ test.total_questions }}</span>
                    <span class="percentage">({{ "%.1f"|format(test.score / test.total_questions * 100) }}%)</span>
                </div>
                <div class="test-time">{{ test.time_taken }}s</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Download Modal -->
<div id="downloadModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Download Resources</h2>
            <button id="closeModalBtn" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p>Select a file to download. Free users are limited to 3 downloads.</p>
            <div id="pdf-list" class="file-list">
                <!-- PDF links will be inserted here by JavaScript -->
            </div>
        </div>
        <div class="modal-footer">
            <button id="closeModalFooterBtn" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    feather.replace(); // Initialize Feather icons

    const downloadBtn = document.getElementById('downloadResourcesBtn');
    const modal = document.getElementById('downloadModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeModalFooterBtn = document.getElementById('closeModalFooterBtn');
    const pdfListContainer = document.getElementById('pdf-list');

    if (downloadBtn) {
        downloadBtn.addEventListener('click', async (e) => {
            e.preventDefault(); // Prevent default link behavior

            // Fetch PDF list from the API
            try {
                const response = await fetch('/api/pdfs');
                if (!response.ok) {
                    throw new Error('Failed to fetch PDF list.');
                }
                const pdfs = await response.json();

                // Clear previous list
                pdfListContainer.innerHTML = '';

                if (pdfs.length > 0) {
                    const list = document.createElement('ul');
                    list.className = 'download-list';
                    pdfs.forEach(pdf => {
                        const item = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = pdf.url;
                        link.textContent = pdf.name;
                        link.classList.add('download-link');
                        item.appendChild(link);
                        list.appendChild(item);
                    });
                    pdfListContainer.appendChild(list);
                } else {
                    pdfListContainer.innerHTML = '<p>No PDF resources are available at the moment.</p>';
                }

                // Show the modal
                modal.style.display = 'flex';
                document.body.classList.add('modal-open');

            } catch (error) {
                console.error('Error fetching PDFs:', error);
                alert('Could not load PDF resources. Please try again later.');
            }
        });
    }

    function closeModal() {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }

    if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
    if(closeModalFooterBtn) closeModalFooterBtn.addEventListener('click', closeModal);

    // Close modal if clicking outside of it
    window.addEventListener('click', (event) => {
        if (event.target == modal) {
            closeModal();
        }
    });
});
</script>
{% endblock %}
